@model DATN_TMS.Areas.BCNKhoa.Models.QuanLyHoiDongBaoCaoEditViewModel

@{
    ViewData["Title"] = "Cập nhật hội đồng báo cáo";
}

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    .content-card { background-color: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.05); min-height: calc(100vh - 140px); }
    .page-title { font-size: 20px; font-weight: 700; color: #2c3e50; margin: 0; text-transform: uppercase; }
    
    .form-group { margin-bottom: 15px; }
    .form-control { width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; outline: none; margin-top: 5px; }
    .form-control[readonly] { background-color: #f8f9fa; color: #666; }
    
    .btn { padding: 8px 16px; border-radius: 4px; cursor: pointer; border: none; font-size: 14px; display: inline-flex; align-items: center; gap: 5px; color: white; transition: 0.2s; }
    .btn-primary { background-color: #484BE0; }
    .btn-save { background-color: #484BE0; padding: 10px 25px; font-size: 16px; }
    .btn-save:hover { background-color: #3a3dc0; }
    
    .tab-header { display: flex; border-bottom: 2px solid #eee; margin-bottom: 20px; margin-top: 20px; }
    .tab-btn { padding: 10px 20px; cursor: pointer; font-weight: 600; color: #666; border-bottom: 2px solid transparent; transition: all 0.3s; }
    .tab-btn:hover { color: #484BE0; }
    .tab-btn.active { color: #484BE0; border-bottom: 2px solid #484BE0; }
    .tab-content { display: none; animation: fadeIn 0.3s; }
    .tab-content.active { display: block; }

    .toggle-btn { background: none; border: none; cursor: pointer; color: #484BE0; font-size: 14px; }
    .student-table { width: 100%; margin-top: 10px; background: #f8f9fa; border-radius: 4px; }
    .student-table th { background: #e9ecef; font-size: 12px; padding: 8px; text-align: left;}
    .student-table td { font-size: 12px; padding: 8px; border-bottom: 1px solid #dee2e6; }
    
    .member-search-container { position: relative; flex: 1; }
    .suggestion-box { position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #ddd; z-index: 10; display: none; max-height: 200px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .suggestion-item { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee; }
    .suggestion-item:hover { background-color: #f1f1f1; }
    
    .selected-user-display { display: none; flex: 1; align-items: center; gap: 10px; background: #eef2ff; padding: 8px 12px; border-radius: 4px; border: 1px solid #484BE0; color: #484BE0; font-weight: 500; margin-top: 0; }
    .btn-remove-selection { cursor: pointer; color: #d9534f; margin-left: auto; }

    .main-table { width: 100%; border-collapse: collapse; }
    .main-table th { background-color: #f8f9fa; border-bottom: 2px solid #eee; padding: 10px; text-align: left; font-size: 13px; color: #444; }
    .main-table td { border-bottom: 1px solid #eee; padding: 10px; font-size: 13px; color: #333; vertical-align: middle; }
    
    @@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>

<div class="content-body">
    <div class="content-card">
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 class="page-title">Quản lý hội đồng báo cáo</h2>
            <a asp-action="Index" style="color:#666; font-size:14px; text-decoration: none;">
                <i class="fa-solid fa-arrow-left"></i> Quay lại
            </a>
        </div>

        <form id="mainForm" asp-action="Edit" method="post">
            <input type="hidden" name="Id" value="@Model.Id" />
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                <div class="form-group">
                    <label style="font-weight: 600;">Mã hội đồng:</label>
                    <input name="MaHoiDong" value="@Model.MaHoiDong" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label style="font-weight: 600;">Tên hội đồng:</label>
                    <input name="TenHoiDong" value="@Model.TenHoiDong" class="form-control">
                </div>
                 <div class="form-group">
                    <label style="font-weight: 600;">Bộ môn:</label>
                    <select name="IdBoMon" asp-items="ViewBag.ListBoMon" class="form-control"></select>
                </div>
                <div class="form-group">
                    <label style="font-weight: 600;">Ngày báo cáo:</label>
                    <input type="date" name="NgayBaoCao" value="@Model.NgayBaoCao?.ToString("yyyy-MM-dd")" class="form-control">
                </div>
                <div class="form-group">
                    <label style="font-weight: 600;">Địa điểm:</label>
                    <input name="DiaDiem" value="@Model.DiaDiem" class="form-control">
                </div>
                <div class="form-group">
                    <label style="font-weight: 600;">Thời gian dự kiến:</label>
                    <input type="time" name="ThoiGianDuKien" value="@Model.ThoiGianDuKien?.ToString("HH:mm")" class="form-control">
                </div>
            </div>
        </form>

        <div class="tab-header">
            <div class="tab-btn active" onclick="switchTab('tabMembers', this)">Thành viên</div>
            <div class="tab-btn" onclick="switchTab('tabTopics', this)">Đề tài</div>
        </div>

        <div id="tabMembers" class="tab-content active">
            <div class="add-member-bar" style="display: flex; gap: 10px; margin-bottom: 20px; align-items: flex-end;">
                
                <div class="member-search-container" id="searchContainer">
                    <input type="text" id="inputSearch" class="form-control" placeholder="Nhập tên, email hoặc MSSV giảng viên..." autocomplete="off">
                    <div class="suggestion-box" id="suggestionBox"></div>
                </div>

                <div class="selected-user-display" id="selectedDisplay">
                    <span id="selectedNameText"></span>
                    <input type="hidden" id="selectedId">
                    <i class="fa-solid fa-xmark btn-remove-selection" id="btnClearSelection" title="Bỏ chọn"></i>
                </div>

                <select class="form-control" id="selectRole" style="width: 150px; margin-top: 0;">
                    <option value="UY_VIEN">Ủy viên</option>
                    <option value="THU_KY">Thư ký</option>
                    <option value="CHU_TICH">Chủ tịch</option>
                    <option value="PHAN_BIEN">Phản biện</option>
                </select>

                <button class="btn btn-primary" id="btnAddMember" style="height: 36px;">
                    <i class="fa-solid fa-plus"></i> Thêm
                </button>
            </div>
            
            <table class="main-table" id="memberTable">
                <thead>
                    <tr>
                        <th>Mã GV</th>
                        <th>Họ và tên</th>
                        <th>Email</th>
                        <th>Vai trò</th>
                        <th class="text-center">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.ThanhViens != null)
                    {
                        foreach (var tv in Model.ThanhViens)
                        {
                            <tr id="row-member-@tv.">
                                <td>@tv.MaGV</td>
                                <td>@tv.TenGiangVien</td>
                                <td>@tv.Email</td>
                                <td>
                                    @if(tv.VaiTro == "CHU_TICH") { <span class="badge bg-primary text-white p-2 rounded">Chủ tịch</span> }
                                    else if(tv.VaiTro == "THU_KY") { <span class="badge bg-info text-dark p-2 rounded">Thư ký</span> }
                                    else if(tv.VaiTro == "PHAN_BIEN") { <span class="badge bg-warning text-dark p-2 rounded">Phản biện</span> }
                                    else { <span class="badge bg-secondary text-white p-2 rounded">Ủy viên</span> }
                                </td>
                                <td class="text-center">
                                    <button class="btn btn-sm" onclick="removeMember(@Model.Id, @tv.)" style="color:#dc3545; background:none;">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>

        <div id="tabTopics" class="tab-content">
            <div style="display: flex; gap: 15px; margin-bottom: 20px; align-items: flex-end;">
                <div class="member-search-container" style="position: relative; flex: 1;">
                    <label style="font-size:13px; font-weight:500; margin-bottom:6px; display:block;">Thêm đề tài:</label>
                    <div style="display:flex; gap: 10px;">
                        <input type="text" id="topicSearch" class="form-control" placeholder="Nhập tên hoặc mã đề tài..." autocomplete="off" style="margin-top:0;">
                        <input type="hidden" id="selectedTopicId">
                        <button class="btn btn-primary" id="btnAddTopic" style="background:#6f42c1; height: 36px;"> 
                            <i class="fa-solid fa-plus"></i> Thêm
                        </button>
                    </div>
                    <div class="suggestion-box" id="topicSuggestionBox" style="top: 100%;"></div>
                </div>
            </div>

            <div class="table-responsive">
                <table class="main-table" id="topicTable">
                    <thead>
                        <tr>
                            <th style="width: 50px;"></th>
                            <th>Tên đề tài</th>
                            <th>Chuyên ngành</th>
                            <th>GV Hướng dẫn</th>
                            <th class="text-center">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.DeTais != null)
                        {
                            foreach (var dt in Model.DeTais)
                            {
                                <tr class="parent-row" id="row-topic-@dt.IdDeTai">
                                    <td class="text-center">
                                        <button class="toggle-btn" onclick="toggleRow(this)"><i class="fa-solid fa-plus"></i></button>
                                    </td>
                                    <td style="font-weight: 500;">
                                        @dt.TenDeTai <br/>
                                        <small style="color:#666">(@dt.MaDeTai)</small>
                                    </td>
                                    <td>@dt.ChuyenNganh</td>
                                    <td>@dt.GVHD</td>
                                    <td class="text-center">
                                        <button class="btn btn-sm" onclick="removeTopic(@Model.Id, @dt.IdDeTai)" style="color:#dc3545; background:none;">
                                            <i class="fa-solid fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr class="detail-row" style="display:none; background-color: #fcfcfc;">
                                    <td colspan="5" style="padding: 10px 20px;">
                                        <table class="student-table">
                                            <thead>
                                                <tr>
                                                    <th>MSSV</th>
                                                    <th>Họ và tên sinh viên</th>
                                                    <th>Khóa</th>
                                                    <th>Chuyên ngành</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var sv in dt.SinhViens)
                                                {
                                                    <tr>
                                                        <td>@sv.MSSV</td>
                                                        <td>@sv.HoTen</td>
                                                        <td>@sv.LopKhoa</td>
                                                        <td>@sv.ChuyenNganh</td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <div style="margin-top:30px; display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid #eee; padding-top: 20px;">
            @if(Model.TrangThai)
            {
                 <span class="text-success" style="font-weight:bold; padding: 10px; display:flex; align-items:center; gap:5px;">
                     <i class="fa-solid fa-check-circle"></i> Hội đồng đã được duyệt
                 </span>
            }
            
            <button type="button" class="btn btn-save" onclick="document.getElementById('mainForm').submit()">
                <i class="fa-solid fa-floppy-disk"></i> Lưu
            </button>
            
            @if(!Model.TrangThai)
            {
                <button class="btn" style="background-color: #28a745; color: white;" onclick="approveCouncil()">
                    <i class="fa-solid fa-check"></i> Duyệt hội đồng
                </button>
            }
        </div>

    </div>
</div>

<script>
    const councilId = @Model.Id;

    // 1. Chuyển Tab
    function switchTab(tabId, btn) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        btn.classList.add('active');
    }

    // 2. Toggle Row (Hiện danh sách sinh viên)
    function toggleRow(btn) {
        const tr = btn.closest('tr');
        const detailRow = tr.nextElementSibling;
        const icon = btn.querySelector('i');
        
        if (detailRow.style.display === 'none') {
            detailRow.style.display = 'table-row';
            icon.classList.remove('fa-plus');
            icon.classList.add('fa-minus');
        } else {
            detailRow.style.display = 'none';
            icon.classList.remove('fa-minus');
            icon.classList.add('fa-plus');
        }
    }

    // ===== LOGIC TÌM KIẾM & THÊM THÀNH VIÊN =====
    const inputSearch = document.getElementById('inputSearch');
    const suggestionBox = document.getElementById('suggestionBox');
    const selectedDisplay = document.getElementById('selectedDisplay');
    const selectedNameText = document.getElementById('selectedNameText');
    const selectedId = document.getElementById('selectedId');
    const btnClearSelection = document.getElementById('btnClearSelection');
    const selectRole = document.getElementById('selectRole');
    const btnAddMember = document.getElementById('btnAddMember');
    const searchContainer = document.getElementById('searchContainer');

    let searchTimeout;

    inputSearch.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const keyword = this.value.trim();
        
        if (keyword.length < 2) {
            suggestionBox.style.display = 'none';
            return;
        }

        searchTimeout = setTimeout(() => {
            fetch(`@Url.Action("SearchMembers")?term=${encodeURIComponent(keyword)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.length > 0) {
                        suggestionBox.innerHTML = data.map(item => 
                            `<div class="suggestion-item" data-id="${item.id}" data-name="${item.label}" data-email="${item.email}" data-magv="${item.maGV}">
                                <strong>${item.label}</strong><br>
                                <small>${item.email} (${item.maGV})</small>
                            </div>`
                        ).join('');
                        suggestionBox.style.display = 'block';

                        // Click vào suggestion
                        document.querySelectorAll('.suggestion-item').forEach(item => {
                            item.addEventListener('click', function() {
                                selectedId.value = this.dataset.id;
                                selectedNameText.textContent = `${this.dataset.name} (${this.dataset.magv})`;
                                
                                // Ẩn search box, hiện selected display
                                searchContainer.style.display = 'none';
                                selectedDisplay.style.display = 'flex';
                                suggestionBox.style.display = 'none';
                            });
                        });
                    } else {
                        suggestionBox.innerHTML = '<div class="suggestion-item">Không tìm thấy</div>';
                        suggestionBox.style.display = 'block';
                    }
                })
                .catch(err => console.error(err));
        }, 300);
    });

    // Bỏ chọn
    btnClearSelection.addEventListener('click', function() {
        selectedId.value = '';
        selectedNameText.textContent = '';
        inputSearch.value = '';
        searchContainer.style.display = 'block';
        selectedDisplay.style.display = 'none';
    });

    // Thêm thành viên
    btnAddMember.addEventListener('click', function() {
        const teacherId = selectedId.value;
        const role = selectRole.value;

        if (!teacherId) {
            alert('Vui lòng chọn giảng viên!');
            return;
        }

        fetch(`@Url.Action("AddMember")?councilId=${councilId}&teacherId=${teacherId}&role=${role}`, {
            method: 'POST'
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                // Thêm dòng mới vào bảng
                const tbody = document.querySelector('#memberTable tbody');
                const roleLabel = getRoleLabel(data.data.vaiTro);
                
                const newRow = `
                    <tr id="row-member-${data.data.idGiangVien}">
                        <td>${data.data.maGV}</td>
                        <td>${data.data.tenGiangVien}</td>
                        <td>${data.data.email}</td>
                        <td>${roleLabel}</td>
                        <td class="text-center">
                            <button class="btn btn-sm" onclick="removeMember(${councilId}, ${data.data.idGiangVien})" style="color:#dc3545; background:none;">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', newRow);

                // Reset
                btnClearSelection.click();
                alert('Đã thêm thành viên!');
            } else {
                alert(data.message);
            }
        });
    });

    function getRoleLabel(role) {
        const roles = {
            'CHU_TICH': '<span class="badge bg-primary text-white p-2 rounded">Chủ tịch</span>',
            'THU_KY': '<span class="badge bg-info text-dark p-2 rounded">Thư ký</span>',
            'PHAN_BIEN': '<span class="badge bg-warning text-dark p-2 rounded">Phản biện</span>',
            'UY_VIEN': '<span class="badge bg-secondary text-white p-2 rounded">Ủy viên</span>'
        };
        return roles[role] || roles['UY_VIEN'];
    }

    // ===== LOGIC TÌM KIẾM & THÊM ĐỀ TÀI =====
    const topicSearch = document.getElementById('topicSearch');
    const topicSuggestionBox = document.getElementById('topicSuggestionBox');
    const selectedTopicId = document.getElementById('selectedTopicId');
    const btnAddTopic = document.getElementById('btnAddTopic');

    let topicSearchTimeout;

    topicSearch.addEventListener('input', function() {
        clearTimeout(topicSearchTimeout);
        const keyword = this.value.trim();
        
        if (keyword.length < 2) {
            topicSuggestionBox.style.display = 'none';
            return;
        }

        topicSearchTimeout = setTimeout(() => {
            fetch(`@Url.Action("SearchTopics")?term=${encodeURIComponent(keyword)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.length > 0) {
                        topicSuggestionBox.innerHTML = data.map(item => 
                            `<div class="suggestion-item" data-id="${item.id}">
                                <strong>${item.label}</strong><br>
                                <small>Mã: ${item.maDeTai} | GVHD: ${item.gvhd}</small>
                            </div>`
                        ).join('');
                        topicSuggestionBox.style.display = 'block';

                        document.querySelectorAll('#topicSuggestionBox .suggestion-item').forEach(item => {
                            item.addEventListener('click', function() {
                                selectedTopicId.value = this.dataset.id;
                                topicSearch.value = this.querySelector('strong').textContent;
                                topicSuggestionBox.style.display = 'none';
                            });
                        });
                    } else {
                        topicSuggestionBox.innerHTML = '<div class="suggestion-item">Không tìm thấy</div>';
                        topicSuggestionBox.style.display = 'block';
                    }
                });
        }, 300);
    });

    btnAddTopic.addEventListener('click', function() {
        const topicId = selectedTopicId.value;

        if (!topicId) {
            alert('Vui lòng chọn đề tài!');
            return;
        }

        fetch(`@Url.Action("AddTopic")?councilId=${councilId}&topicId=${topicId}`, {
            method: 'POST'
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                location.reload(); // Reload để hiển thị đầy đủ thông tin
            } else {
                alert(data.message);
            }
        });
    });

    // ===== XÓA THÀNH VIÊN =====
    function removeMember(councilId, teacherId) {
        if(!confirm('Xóa thành viên này?')) return;
        
        fetch(`@Url.Action("RemoveMember")?councilId=${councilId}&teacherId=${teacherId}`, { 
            method: 'POST' 
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                document.getElementById(`row-member-${teacherId}`).remove();
            } else {
                alert(data.message);
            }
        });
    }

    // ===== XÓA ĐỀ TÀI =====
    function removeTopic(councilId, topicId) {
        if(!confirm('Xóa đề tài này khỏi hội đồng?')) return;
        
        fetch(`@Url.Action("RemoveTopic")?councilId=${councilId}&topicId=${topicId}`, { 
            method: 'POST' 
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                const row = document.getElementById(`row-topic-${topicId}`);
                if(row) {
                    if(row.nextElementSibling && row.nextElementSibling.classList.contains('detail-row')) {
                        row.nextElementSibling.remove();
                    }
                    row.remove();
                }
            } else {
                alert(data.message);
            }
        });
    }

    // ===== DUYỆT HỘI ĐỒNG =====
    function approveCouncil() {
        Swal.fire({
            title: 'Duyệt hội đồng?',
            text: "Hành động này sẽ chốt danh sách và công bố lịch bảo vệ.",
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Duyệt ngay',
            confirmButtonColor: '#28a745',
            cancelButtonText: 'Hủy'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`@Url.Action("ApproveCouncil")?councilId=${councilId}`, { 
                    method: 'POST' 
                })
                .then(res => res.json())
                .then(data => {
                    if(data.success) {
                        Swal.fire('Thành công!', data.message, 'success')
                            .then(() => location.reload());
                    } else {
                        Swal.fire('Lỗi!', data.message, 'error');
                    }
                });
            }
        });
    }
</script>