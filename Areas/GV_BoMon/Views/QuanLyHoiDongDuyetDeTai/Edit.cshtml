@model DATN_TMS.Areas.GV_BoMon.Models.QuanLyHoiDongEditViewModel

@{
    ViewData["Title"] = "Chi tiết hội đồng duyệt đề tài";
}

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    .content-card { background-color: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.05); min-height: calc(100vh - 140px); }
    .page-header-wrapper { border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
    .page-title { font-size: 20px; font-weight: 700; color: #2c3e50; margin: 0 0 5px 0; text-transform: uppercase; }
    .breadcrumb-area { font-size: 13px; color: #666; }
    .breadcrumb-area a { text-decoration: none; color: #484BE0; }
    .breadcrumb-area span { margin: 0 5px; color: #ccc; }
    .form-control { width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; outline: none; margin-top: 5px; box-sizing: border-box; }
    .form-control:focus { border-color: #484BE0; }
    .btn { padding: 8px 16px; border-radius: 4px; cursor: pointer; border: none; font-size: 14px; display: inline-flex; align-items: center; gap: 5px; color: white; }
    .btn-primary { background-color: #484BE0; }
    .btn-primary:hover { background-color: #3a3dc0; }
    .btn-save { background-color: #484BE0; padding: 10px 25px; font-size: 16px; }
    .btn-save:hover { background-color: #3a3dc0; }
    
    /* Thanh thêm thành viên */
    .add-member-bar { display: flex; gap: 10px; align-items: flex-end; margin-bottom: 20px; flex-wrap: wrap; background: #f9f9f9; padding: 15px; border-radius: 6px; }
    .member-search-container { position: relative; flex: 1; min-width: 250px; }
    .selected-user-display { display: none; flex: 1; align-items: center; gap: 10px; background: #eef2ff; padding: 8px 12px; border-radius: 4px; border: 1px solid #484BE0; color: #484BE0; font-weight: 500; height: 38px; margin-top: 5px; }
    .suggestion-box { position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #ddd; z-index: 10; display: none; max-height: 200px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 4px; }
    .suggestion-item { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #eee; }
    .suggestion-item:hover { background-color: #f1f1f1; }
    .suggestion-item:last-child { border-bottom: none; }
    .btn-remove-selection { cursor: pointer; color: #d9534f; margin-left: auto; }
    .table-responsive { width: 100%; margin-top: 10px; }
    table { width: 100%; border-collapse: collapse; }
    th { background: #f8f9fa; padding: 10px; text-align: left; border-bottom: 2px solid #eee; font-size: 13px; }
    td { padding: 10px; border-bottom: 1px solid #eee; font-size: 13px; }
    
    .badge-role { background:#eee; color:#333; padding:4px 10px; border-radius:4px; font-size: 12px; }
    .badge-role.chu-tich { background: #e74c3c; color: white; }
    .badge-role.thu-ky { background: #3498db; color: white; }
    .badge-role.uy-vien { background: #95a5a6; color: white; }
    
    .section-title { margin-bottom:15px; color:#c0392b; font-weight:700; font-size: 16px; }
    .no-data { text-align: center; padding: 30px; color: #999; font-style: italic; }
</style>

<div class="content-body">
    <div class="content-card">
        <div class="page-header-wrapper">
            <h2 class="page-title">CHI TIẾT HỘI ĐỒNG: @Model.MaHoiDong</h2>
            <div class="breadcrumb-area">
                <a asp-action="Index">Danh sách hội đồng</a>
                <span>/</span>
                <span style="color: #333; font-weight: 500;">@Model.MaHoiDong</span>
            </div>
        </div>

        <form asp-action="Edit" method="post">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="Id" />
            <input type="hidden" asp-for="MaHoiDong" />

            <div class="form-section">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:15px;">
                    <div class="form-group">
                        <label>Tên hội đồng:</label>
                        <input type="text" asp-for="TenHoiDong" class="form-control" placeholder="Nhập tên hội đồng" required>
                    </div>
                    <div class="form-group">
                        <label>Bộ môn:</label>
                        <select asp-for="IdBoMon" class="form-control" asp-items="ViewBag.ListBoMon">
                            <option value="">-- Chọn bộ môn --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ngày bắt đầu:</label>
                        <input type="date" asp-for="NgayBatDau" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Ngày kết thúc:</label>
                        <input type="date" asp-for="NgayKetThuc" class="form-control">
                    </div>
                </div>
            </div>

            <hr style="margin: 30px 0; border: 0; border-top: 1px solid #eee;">

            <h4 class="section-title"><i class="fa-solid fa-users"></i> Danh sách thành viên hội đồng</h4>

            <div class="add-member-bar">
                <div class="member-search-container" id="searchContainer">
                    <label style="font-weight: 500; font-size: 13px;">Tìm giảng viên:</label>
                    <input type="text" id="inputSearch" class="form-control" placeholder="Nhập tên, email hoặc mã giảng viên..." autocomplete="off">
                    <div class="suggestion-box" id="suggestionBox"></div>
                </div>

                <div class="selected-user-display" id="selectedDisplay">
                    <span id="selectedNameText"></span>
                    <input type="hidden" id="selectedId">
                    <i class="fa-solid fa-xmark btn-remove-selection" id="btnClearSelection" title="Bỏ chọn"></i>
                </div>

                <div>
                    <label style="font-weight: 500; font-size: 13px;">Vai trò:</label>
                    <select class="form-control" id="selectRole" style="width: 150px;">
                        <option value="UY_VIEN">Ủy viên</option>
                        <option value="THU_KY">Thư ký</option>
                        <option value="CHU_TICH">Chủ tịch</option>
                    </select>
                </div>

                <div style="padding-top: 20px;">
                    <button class="btn btn-primary" id="btnAddMember" type="button">
                        <i class="fa-solid fa-plus"></i> Thêm
                    </button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table" id="memberTable">
                    <thead>
                        <tr>
                            <th style="width: 100px;">Mã GV</th>
                            <th>Họ và tên</th>
                            <th>Email</th>
                            <th>Học vị</th>
                            <th style="width: 120px;">Vai trò</th>
                            <th class="text-center" style="width: 80px;">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.ThanhViens != null && Model.ThanhViens.Any())
                        {
                            foreach (var tv in Model.ThanhViens)
                            {
                                var badgeClass = tv.VaiTro switch
                                {
                                    "CHU_TICH" => "chu-tich",
                                    "THU_KY" => "thu-ky",
                                    _ => "uy-vien"
                                };
                                var vaiTroDisplay = tv.VaiTro switch
                                {
                                    "CHU_TICH" => "Chủ tịch",
                                    "THU_KY" => "Thư ký",
                                    _ => "Ủy viên"
                                };
                                
                                <tr id="row-@tv.IdNguoiDung">
                                    <td>@tv.MaGV</td>
                                    <td>@tv.TenGiangVien</td>
                                    <td>@tv.Email</td>
                                    <td>@tv.HocVi</td>
                                    <td><span class="badge-role @badgeClass">@vaiTroDisplay</span></td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-sm" onclick="removeMember(@Model.Id, @tv.IdNguoiDung)" 
                                                style="background:#e74c3c; padding: 4px 10px; font-size: 12px;">
                                            <i class="fa-solid fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr id="noDataRow">
                                <td colspan="6" class="no-data">Chưa có thành viên nào trong hội đồng</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div style="margin-top:30px; display: flex; justify-content: flex-end; border-top: 1px solid #eee; padding-top: 20px;">
                <button type="submit" class="btn btn-save">
                    <i class="fa-solid fa-floppy-disk"></i> Lưu thay đổi
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    const councilId = @Model.Id;

    // 1. HIỂN THỊ THÔNG BÁO
    document.addEventListener("DOMContentLoaded", function() {
        @if (TempData["Success"] != null)
        {
            <text>
            Swal.fire({
                icon: 'success',
                title: 'Thành công!',
                text: '@Html.Raw(TempData["Success"])',
                timer: 2000,
                showConfirmButton: false
            });
            </text>
        }
        @if (TempData["Error"] != null)
        {
            <text>
            Swal.fire({ 
                icon: 'error', 
                title: 'Lỗi!', 
                text: '@Html.Raw(TempData["Error"])' 
            });
            </text>
        }
    });

    // 2. TÌM KIẾM GIẢNG VIÊN
    const inputSearch = document.getElementById('inputSearch');
    const suggestionBox = document.getElementById('suggestionBox');
    const selectedDisplay = document.getElementById('selectedDisplay');
    const searchContainer = document.getElementById('searchContainer');
    const selectedNameText = document.getElementById('selectedNameText');
    const selectedId = document.getElementById('selectedId');
    let timeout = null;

    inputSearch.addEventListener('input', function() {
        clearTimeout(timeout);
        const query = this.value;
        if(query.length < 2) { 
            suggestionBox.style.display = 'none'; 
            return; 
        }

        timeout = setTimeout(() => {
            fetch(`@Url.Action("SearchGiangVien")?term=${encodeURIComponent(query)}`)
                .then(res => res.json())
                .then(data => {
                    suggestionBox.innerHTML = '';
                    if(data.length > 0) {
                        suggestionBox.style.display = 'block';
                        data.forEach(item => {
                            const div = document.createElement('div');
                            div.className = 'suggestion-item';
                            div.innerHTML = `
                                <strong>${item.hoTen}</strong> <small style="color:#888;">(${item.maGv})</small>
                                <br><small style="color:#666;">${item.email} - ${item.hocVi || 'Chưa cập nhật'}</small>
                            `;
                            div.onclick = () => selectTeacher(item);
                            suggestionBox.appendChild(div);
                        });
                    } else { 
                        suggestionBox.innerHTML = '<div class="suggestion-item" style="color:#999;">Không tìm thấy giảng viên</div>';
                        suggestionBox.style.display = 'block';
                    }
                })
                .catch(err => {
                    console.error('Lỗi tìm kiếm:', err);
                    suggestionBox.style.display = 'none';
                });
        }, 300);
    });

    // Ẩn suggestion khi click ra ngoài
    document.addEventListener('click', function(e) {
        if (!searchContainer.contains(e.target)) {
            suggestionBox.style.display = 'none';
        }
    });

    function selectTeacher(item) {
        selectedId.value = item.id;
        selectedNameText.innerText = `${item.hoTen} (${item.maGv})`;
        searchContainer.style.display = 'none';
        selectedDisplay.style.display = 'flex';
        suggestionBox.style.display = 'none';
        
        // Lưu tạm data
        selectedDisplay.dataset.id = item.id;
        selectedDisplay.dataset.name = item.hoTen;
        selectedDisplay.dataset.email = item.email;
        selectedDisplay.dataset.magv = item.maGv;
        selectedDisplay.dataset.hocvi = item.hocVi || '';
    }

    document.getElementById('btnClearSelection').onclick = function() {
        searchContainer.style.display = 'block';
        selectedDisplay.style.display = 'none';
        inputSearch.value = '';
        selectedId.value = '';
    };

    // 3. THÊM THÀNH VIÊN
    document.getElementById('btnAddMember').onclick = function() {
        const idGV = selectedId.value;
        const role = document.getElementById('selectRole').value;

        if(!idGV) { 
            Swal.fire('Chú ý', 'Vui lòng chọn giảng viên trước!', 'warning'); 
            return; 
        }

        // Gửi request thêm thành viên
        fetch('@Url.Action("AddMember")', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                CouncilId: councilId,
                IdGiangVien: parseInt(idGV), 
                VaiTro: role 
            })
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                // Xóa dòng "Chưa có thành viên" nếu có
                const noDataRow = document.getElementById('noDataRow');
                if (noDataRow) noDataRow.remove();

                // Thêm vào bảng (UI)
                const table = document.getElementById('memberTable').getElementsByTagName('tbody')[0];
                const newRow = table.insertRow();
                newRow.id = `row-${idGV}`;
                
                const badgeClass = role === 'CHU_TICH' ? 'chu-tich' : (role === 'THU_KY' ? 'thu-ky' : 'uy-vien');
                const vaiTroDisplay = role === 'CHU_TICH' ? 'Chủ tịch' : (role === 'THU_KY' ? 'Thư ký' : 'Ủy viên');
                
                newRow.innerHTML = `
                    <td>${selectedDisplay.dataset.magv || '...'}</td>
                    <td>${selectedDisplay.dataset.name}</td>
                    <td>${selectedDisplay.dataset.email}</td>
                    <td>${selectedDisplay.dataset.hocvi || ''}</td>
                    <td><span class="badge-role ${badgeClass}">${vaiTroDisplay}</span></td>
                    <td class="text-center">
                        <button type="button" class="btn btn-sm" onclick="removeMember(${councilId}, ${idGV})" 
                                style="background:#e74c3c; padding: 4px 10px; font-size: 12px;">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </td>
                `;
                
                // Reset form
                document.getElementById('btnClearSelection').click();
                
                Swal.fire({ 
                    icon: 'success', 
                    title: 'Đã thêm!', 
                    text: data.message,
                    timer: 1500, 
                    showConfirmButton: false 
                });
            } else {
                Swal.fire('Không thể thêm', data.message, 'error');
            }
        })
        .catch(err => {
            console.error('Lỗi:', err);
            Swal.fire('Lỗi', 'Lỗi kết nối Server', 'error');
        });
    };

    // 4. XÓA THÀNH VIÊN
    function removeMember(councilId, teacherId) {
        Swal.fire({
            title: 'Xóa thành viên?',
            text: "Bạn có chắc chắn muốn xóa thành viên này khỏi hội đồng?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Xóa ngay',
            cancelButtonText: 'Hủy'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch('@Url.Action("RemoveMember")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        CouncilId: councilId, 
                        IdGiangVien: teacherId 
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if(data.success) {
                        // Xóa dòng khỏi bảng
                        const row = document.getElementById(`row-${teacherId}`);
                        if(row) row.remove();
                        
                        // Kiểm tra nếu bảng rỗng thì hiển thị thông báo
                        const tbody = document.querySelector('#memberTable tbody');
                        if (tbody.rows.length === 0) {
                            const newRow = tbody.insertRow();
                            newRow.id = 'noDataRow';
                            newRow.innerHTML = '<td colspan="6" class="no-data">Chưa có thành viên nào trong hội đồng</td>';
                        }
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'Đã xóa!',
                            text: data.message,
                            timer: 1500,
                            showConfirmButton: false
                        });
                    } else {
                        Swal.fire('Lỗi', data.message, 'error');
                    }
                })
                .catch(err => Swal.fire('Lỗi', 'Lỗi kết nối Server', 'error'));
            }
        });
    }
</script>
