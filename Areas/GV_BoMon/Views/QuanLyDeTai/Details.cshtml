@model DATN_TMS.Areas.BCNKhoa.Models.ChiTietDeTaiViewModel

@{
    ViewData["Title"] = "Chi ti?t ?? tài: " + Model.MaDeTai;
}

<style>
    :root { --primary-red: #D9251C; }

    .content-card {
        background-color: #fff;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 0 10px rgba(0,0,0,0.05);
        min-height: calc(100vh - 140px);
        display: flex;
        flex-direction: column;
    }

    .page-header-row { margin-bottom: 10px; }
    .page-title { 
        font-size: 24px; 
        font-weight: 700; 
        color: #2c3e50; 
        margin: 0; 
        text-transform: uppercase; 
    }

    .breadcrumb-nav { 
        margin-bottom: 25px; 
        padding-bottom: 15px; 
        border-bottom: 2px solid #f5f5f5; 
    }
    .breadcrumb { 
        display: flex; 
        align-items: center; 
        list-style: none; 
        padding: 0; 
        margin: 0; 
        font-size: 13px; 
        background: transparent; 
    }
    .breadcrumb-item a { 
        color: #6c757d; 
        text-decoration: none; 
        transition: color 0.2s; 
    }
    .breadcrumb-item a:hover { 
        color: #D71920; 
        text-decoration: underline; 
    }
    .breadcrumb-item.active { 
        color: #333; 
        font-weight: 600; 
        cursor: default; 
    }
    .breadcrumb-item + .breadcrumb-item::before { 
        content: "/"; 
        padding: 0 8px; 
        color: #ccc; 
    }

    .detail-container { display: flex; gap: 30px; align-items: flex-start; }
    
    .info-section {
        flex: 7; 
        background: white;
        padding: 30px; 
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        border: 1px solid #eee;
    }

    .action-section {
        flex: 3;
        background: white;
        padding: 25px;
        border-radius: 8px;
        border: 1px solid #eee;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        position: sticky;
        top: 20px;
    }

    .detail-group { margin-bottom: 20px; }
    .detail-group label { display: block; font-weight: 600; color: #444; margin-bottom: 8px; font-size: 14px; }
    .detail-control { width: 100%; padding: 10px 15px; border: 1px solid #e0e0e0; border-radius: 4px; background-color: #f9fafb; color: #333; font-size: 14px; resize: none; }
    .detail-control:focus { outline: none; border-color: #ddd; }
    textarea.detail-control { height: 100px; line-height: 1.5; }
    .action-title { font-size: 16px; font-weight: 700; color: var(--primary-red); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
    .current-status { margin-bottom: 20px; padding: 10px; background: #f8f9fa; border-radius: 4px; text-align: center; }
    .status-label { font-size: 13px; color: #666; margin-bottom: 5px; display: block; }
    .status-value { font-weight: 700; font-size: 16px; }
    .status-badge { padding: 6px 12px; border-radius: 12px; font-weight: 700; font-size: 12px; display: inline-block; }
    .status-waiting { color: #d97706; background: #fff7ed; border: 1px solid #fb923c; }
    .status-approved { color: #059669; background: #ecfdf3; border: 1px solid #22c55e; }
    .status-rejected { color: #dc3545; background: #fef2f2; border: 1px solid #ef4444; }

    .feedback-area { margin-bottom: 20px; }
    .feedback-input { width: 100%; height: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; resize: vertical; }
    .feedback-input:focus { border-color: var(--primary-red); outline: none; }
    .feedback-required-msg { color: #dc3545; font-size: 12px; margin-top: 5px; display: none; }

    .btn-row { display: flex; gap: 10px; }
    .btn-action { flex: 1; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 14px; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 5px; }
    .btn-approve { background-color: #059669; color: white; }
    .btn-approve:hover { background-color: #047857; }
    .btn-reject { background-color: #dc3545; color: white; }
    .btn-reject:hover { background-color: #b02a37; }

    .review-list { margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px; display: flex; flex-direction: column; gap: 10px; }
    .review-item { padding: 10px; border: 1px solid #eee; border-radius: 6px; background: #fafafa; }
    .review-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; font-weight: 600; }
    .review-comment { font-size: 13px; color: #333; white-space: pre-wrap; }
</style>

<div class="content-body">
    <div class="content-card">
        
        <div class="page-header-row">
            <h2 class="page-title">Chi ti?t ?? tài</h2>
        </div>

        <nav aria-label="breadcrumb" class="breadcrumb-nav">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a asp-action="Index">Danh sách ?? tài</a></li>
                <li class="breadcrumb-item active" aria-current="page">@Model.MaDeTai</li>
            </ol>
        </nav>

        <div class="detail-container">
            
            <div class="info-section">
                <div style="display: flex; gap: 20px;">
                    <div class="detail-group" style="width: 150px;">
                        <label>Mã ?? tài:</label>
                        <input type="text" class="detail-control" value="@Model.MaDeTai" readonly>
                    </div>
                    <div class="detail-group" style="flex: 1;">
                        <label>Tên ?? tài:</label>
                        <input type="text" class="detail-control" value="@Model.TenDeTai" readonly>
                    </div>
                </div>

                <div style="display: flex; gap: 20px;">
                    <div class="detail-group" style="flex: 1;">
                        <label>Ng??i ?? xu?t ?? tài:</label>
                        <input type="text" class="detail-control" value="@Model.NguoiDeXuat" readonly>
                    </div>
                    <div class="detail-group" style="flex: 1;">
                        <label>Gi?ng viên h??ng d?n:</label>
                        <input type="text" class="detail-control" value="@Model.GVHD" readonly>
                    </div>
                </div>

                <div class="detail-group">
                    <label>Nhóm th?c hi?n:</label>
                    <input type="text" class="detail-control" value="@Model.NhomThucHien" readonly>
                </div>

                <div class="detail-group">
                    <label>M?c tiêu chính:</label>
                    <textarea class="detail-control" readonly>@Model.MucTieu</textarea>
                </div>

                <div class="detail-group">
                    <label>Ph?m vi và ch?c n?ng:</label>
                    <textarea class="detail-control" readonly style="height: 120px;">@Model.PhamVi</textarea>
                </div>

                <div class="detail-group">
                    <label>Công ngh? s? d?ng:</label>
                    <input type="text" class="detail-control" value="@Model.CongNghe" readonly>
                </div>

                <div class="detail-group">
                    <label>Yêu c?u tính m?i:</label>
                    <textarea class="detail-control" readonly>@Model.YeuCauTinhMoi</textarea>
                </div>

                <div class="detail-group">
                    <label>S?n ph?m k?t qu? d? ki?n:</label>
                    <textarea class="detail-control" readonly>@Model.KetQuaDuKien</textarea>
                </div>
            </div>

            <div class="action-section">
                <div class="action-title">
                    <i class="fa-solid fa-gavel"></i> Xét duy?t ?? tài
                </div>

                <div class="current-status">
                    <span class="status-label">Tr?ng thái hi?n t?i:</span>
                    <div id="statusDisplay" class="status-badge 
                        @(Model.TrangThai == "DA_DUYET" ? "status-approved" : 
                          Model.TrangThai == "TU_CHOI" ? "status-rejected" : "status-waiting")">
                        @(Model.TrangThai == "DA_DUYET" ? "?ã duy?t" : 
                          Model.TrangThai == "TU_CHOI" ? "T? ch?i" : "Ch? duy?t")
                    </div>
                    <div style="margin-top:6px; font-size:12px; color:#555;">
                        ?ã nh?n @Model.Reviews.Count/@Model.CouncilMemberCount nh?n xét
                    </div>
                </div>

                @if (Model.CanReview)
                {
                    <div class="feedback-area">
                        <label style="font-weight: 600; font-size: 13px; margin-bottom: 5px; display:block;">
                            Nh?n xét c?a b?n:
                        </label>
                        <textarea id="adminComment" class="feedback-input" placeholder="Nh?p nh?n xét (B?t bu?c n?u t? ch?i)...">@Model.NhanXet</textarea>
                        <div id="feedbackError" class="feedback-required-msg">
                            <i class="fa-solid fa-circle-exclamation"></i> Vui lòng nh?p lý do t? ch?i!
                        </div>
                    </div>

                    <div class="btn-row">
                        <button class="btn-action btn-reject" onclick="tuChoiDeTai(@Model.Id)">
                            <i class="fa-solid fa-xmark"></i> T? ch?i
                        </button>
                        <button class="btn-action btn-approve" onclick="duyetDeTai(@Model.Id)">
                            <i class="fa-solid fa-check"></i> Duy?t
                        </button>
                    </div>
                }
                else
                {
                    <div class="feedback-area">
                        <div style="font-size:13px; color:#555; line-height:1.5;">
                            @(Model.IsProposer ? "B?n là ng??i ?? xu?t, ch? xem ???c nh?n xét." : "Ch? thành viên h?i ??ng m?i ???c duy?t/t? ch?i.")
                        </div>
                    </div>
                }

                <div class="review-list">
                    <div style="font-weight:700; font-size:14px;">Nh?n xét h?i ??ng</div>
                    @if (Model.Reviews.Any())
                    {
                        foreach (var rv in Model.Reviews)
                        {
                            <div class="review-item">
                                <div class="review-header">
                                    <span>@rv.ReviewerName</span>
                                    <span class="status-badge @(rv.Status == "DA_DUYET" ? "status-approved" : rv.Status == "TU_CHOI" ? "status-rejected" : "status-waiting")">
                                        @(rv.Status == "DA_DUYET" ? "?ã duy?t" : rv.Status == "TU_CHOI" ? "T? ch?i" : "Ch? duy?t")
                                    </span>
                                </div>
                                <div class="review-comment">@(!string.IsNullOrWhiteSpace(rv.Comment) ? rv.Comment : "(Ch?a có n?i dung)")</div>
                                @if (rv.CreatedAt.HasValue)
                                {
                                    <div style="font-size:12px; color:#666; margin-top:4px;">@rv.CreatedAt.Value.ToString("dd/MM/yyyy HH:mm")</div>
                                }
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-muted" style="font-size:13px;">Ch?a có nh?n xét nào t? h?i ??ng.</div>
                    }
                </div>
            </div>

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    function duyetDeTai(id) {
        var comment = document.getElementById('adminComment') ? document.getElementById('adminComment').value : '';
        
        Swal.fire({
            title: 'Xác nh?n duy?t?',
            text: "?? tài này s? ???c ch?p nh?n cho sinh viên ??ng ký!",
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#059669',
            confirmButtonText: '??ng ý duy?t',
            cancelButtonText: 'H?y'
        }).then((result) => {
            if (result.isConfirmed) {
                callApi(id, '@Url.Action("DuyetDeTai")', comment, "DA_DUYET");
            }
        });
    }

    function tuChoiDeTai(id) {
        var comment = document.getElementById('adminComment') ? document.getElementById('adminComment').value : '';
        var errorMsg = document.getElementById('feedbackError');

        if (errorMsg && (!comment || !comment.trim())) {
            errorMsg.style.display = 'block';
            if (document.getElementById('adminComment')) {
                document.getElementById('adminComment').focus();
            }
            return;
        }
        if (errorMsg) errorMsg.style.display = 'none';

        Swal.fire({
            title: 'Xác nh?n t? ch?i?',
            text: "?? tài này s? b? h?y b?. B?n ch?c ch?n ch??",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            confirmButtonText: 'T? ch?i ngay',
            cancelButtonText: 'H?y'
        }).then((result) => {
            if (result.isConfirmed) {
                callApi(id, '@Url.Action("TuChoiDeTai")', comment, "TU_CHOI");
            }
        });
    }

    function callApi(id, url, comment, newStatus) {
        let formData = new FormData();
        formData.append('id', id);
        formData.append('nhanXet', comment || '');

        fetch(url, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Swal.fire('Thành công!', data.message, 'success');
                const statusDiv = document.getElementById('statusDisplay');
                if(newStatus === "DA_DUYET") {
                    statusDiv.className = "status-value status-approved";
                    statusDiv.innerText = "?ã duy?t";
                } else {
                    statusDiv.className = "status-value status-rejected";
                    statusDiv.innerText = "?ã t? ch?i";
                }
            } else {
                Swal.fire('L?i!', data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire('L?i h? th?ng', 'Không th? k?t n?i ??n server', 'error');
        });
    }
</script>
