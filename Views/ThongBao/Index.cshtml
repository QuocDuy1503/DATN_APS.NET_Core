@using DATN_TMS.Models
@using Microsoft.AspNetCore.Http
@using X.PagedList
@using X.PagedList.Mvc.Core
@model IPagedList<ThongBao>
@{
    var role = Context.Session.GetString("Role");
    Layout = role switch
    {
        "SV" => "~/Views/Shared/_Layout_SV.cshtml",
        "GV" => "~/Views/Shared/_Layout_GV.cshtml",
        "BO_MON" => "~/Views/Shared/_LayoutGVBoMon.cshtml",
        _ => "~/Views/Shared/_LayoutBCNKhoa.cshtml"
    };
    ViewData["Title"] = "Thông báo";
    var filter = (ViewBag.Filter as string ?? "all").ToLower();
}

<style>
    .notif-page-card { background: #fff; border-radius: 8px; padding: 18px; border: 1px solid #eee; }
    .notif-toolbar { display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap; }
    .notif-filters { display: flex; gap: 8px; flex-wrap: wrap; }
    .notif-filter { padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd; background: #f8f9fa; color: #444; text-decoration: none; font-weight: 600; font-size: 13px; }
    .notif-filter.active { background: #e8ddff; color: #6a1b9a; border-color: #d9c5ff; }
    .notif-list { margin-top: 14px; display: flex; flex-direction: column; gap: 10px; }
    .notif-row { border: 1px solid #f0f0f0; border-radius: 8px; padding: 12px 14px; display: flex; justify-content: space-between; gap: 12px; background: #faf9ff; cursor: pointer; }
    .notif-row.read { background: #fff; opacity: 0.92; }
    .notif-row:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .notif-main { flex: 1; min-width: 0; }
    .notif-title { font-weight: 700; color: #333; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .notif-content { color: #555; font-size: 13px; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .notif-meta { margin-top: 6px; font-size: 12px; color: #888; display: flex; gap: 10px; align-items: center; }
    .badge-read { background: #eef2ff; color: #4b5563; padding: 6px 10px; border-radius: 999px; font-size: 12px; height: fit-content; }
    .btn-mark-read { border: 1px solid #d0c4ff; background: #ede7ff; color: #5c2d91; border-radius: 6px; padding: 8px 12px; font-weight: 700; cursor: pointer; font-size: 12px; height: fit-content; }
    .btn-mark-read:hover { background: #e1d7ff; }
    .notif-empty { padding: 18px; border: 1px dashed #ddd; border-radius: 8px; text-align: center; color: #777; }
    .pagination { margin: 16px 0 4px 0; }
</style>

<div class="content-body">
    <div class="notif-page-card">
        <div class="notif-toolbar">
            <div>
                <h2 style="margin:0; font-size:18px; font-weight:800;">Thông báo c?a b?n</h2>
                <div style="color:#666; font-size:13px;">Nh?n vào thông báo ?? m? chi ti?t ho?c chuy?n ??n liên k?t ?ính kèm.</div>
            </div>
            <div class="notif-filters">
                <a asp-action="Index" asp-route-filter="all" class="notif-filter @(filter == "all" ? "active" : "")">T?t c?</a>
                <a asp-action="Index" asp-route-filter="unread" class="notif-filter @(filter == "unread" ? "active" : "")">Ch?a ??c</a>
                <a asp-action="Index" asp-route-filter="read" class="notif-filter @(filter == "read" ? "active" : "")">?ã ??c</a>
            </div>
        </div>

        <div class="notif-list">
            @if (Model != null && Model.Any())
            {
                foreach (var item in Model)
                {
                    var isRead = item.TrangThaiXem == true;
                    <div class="notif-row @(isRead ? "read" : "unread")" data-id="@item.Id" data-link="@item.LinkLienKet">
                        <div class="notif-main">
                            <div class="notif-title">@item.TieuDe</div>
                            <div class="notif-content">@item.NoiDung</div>
                            <div class="notif-meta">
                                <i class="fa-regular fa-clock"></i>
                                <span>@(item.NgayTao?.ToString("dd/MM/yyyy HH:mm") ?? "")</span>
                            </div>
                        </div>
                        @if (!isRead)
                        {
                            <button type="button" class="btn-mark-read" data-id="@item.Id">?ánh d?u ?ã ??c</button>
                        }
                        else
                        {
                            <span class="badge-read">?ã ??c</span>
                        }
                    </div>
                }
            }
            else
            {
                <div class="notif-empty">Ch?a có thông báo.</div>
            }
        </div>

        <div>
            @Html.PagedListPager(Model, page => Url.Action("Index", new { page, filter }))
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const markButtons = document.querySelectorAll('.btn-mark-read');
        markButtons.forEach(btn => {
            btn.addEventListener('click', async (e) => {
                e.stopPropagation();
                const id = btn.dataset.id;
                await markRead(id);
                window.location.reload();
            });
        });

        const rows = document.querySelectorAll('.notif-row');
        rows.forEach(row => {
            row.addEventListener('click', async () => {
                const id = row.dataset.id;
                const link = row.dataset.link;
                await markRead(id);
                if (link && link.length > 0) {
                    window.location.href = link;
                }
            });
        });
    });

    async function markRead(id) {
        try {
            await fetch('/ThongBao/MarkAsRead', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: parseInt(id) })
            });
        } catch (e) {
            console.error(e);
        }
    }
</script>
